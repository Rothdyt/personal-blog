---
title: Anomaly Detection
author: Yutong
date: '2019-01-04'
slug: anomaly-detection
categories:
  - Statistics
tags:
  - data-analysis
image:
  caption: ''
  focal_point: ''
---

# Point Anomaly Detection - Grubbs' test

Grubbs' test[^fn_grubb] is commonly used technique to detect an outlier in **univariate** problem, where **normality** assumption is required. It can be formualted as either one-side testing problem or two-sided testing problem.

[^fn_grubb]: https://en.wikipedia.org/wiki/Grubbs%27_test_for_outliers

The hypothesis test is defined as

$$H_0: \text{There are no outlier in the data set} \quad H_1: \text{There is exactly one outlier in the data set}.$$
For two-sided testing, it tries to determine whether the observation with the largest absolute deviation is an outlier, where the test statistic is defined as

$$
G = \frac{\max_i |X_i - \bar X|}{s},
$$
where the $\bar X$ is the sample mean and $s$ is the sample deviation.

Let's look at one simulated example.

```{r}
set.seed(123)
simulated_data <- rnorm(100, 0, 1)
simulated_data_with_outliers <- c(simulated_data, c(3.5, -3.7))
# normality check
shapiro.test(simulated_data_with_outliers)
```
Shapiro-Wilk normality test impiles the data is normally distributed. Now, let's performe the grubbs' test.

```{r}
library(outliers)
grubbs.test(simulated_data_with_outliers, two.sided = TRUE)
```

The test result detecs the lowest value as an outlier.

Let's remove the -3.7 and performe the test again.

```{r}
grubbs.test(head(simulated_data_with_outliers,101), two.sided = TRUE)
```

Finally, let's remove two outliers altogether.

```{r}
grubbs.test(head(simulated_data_with_outliers,100), two.sided = TRUE)
```
This impiles there are no outliers.

Grubbs' test is useful for identify the outliers of a small amount one at a time, but not suitable to detect a group of outliers.

# Collective Anomaly Detection

## Anomaly in timeseries - Seasonal Hybrid ESD algorithm

[download data](https://raw.githubusercontent.com/Rothdyt/personal-blog/master/static/files/river.csv)

```{r}
#  devtools::install_github("twitter/AnomalyDetection")
library(AnomalyDetection)
river <- read.csv("../../static/files/river.csv")
results <- AnomalyDetectionVec(river$nitrate, period=12, direction = 'both', plot = T)
```
```{r}
results$plot
```

## Distance-based Anomaly Detection

# Global Anomaly - Largest Distance

Intuitively, the larger distance the more likely the point would be an outlier.

```{r}
library(FNN)
#furniture <- read.csv("../../static/files/post_data/furniture.csv")
furniture_scaled <- data.frame(Height = scale(furniture$Height), Width = scale(furniture$Width))
furniture_knn <- get.knn(furniture_scaled, k = 5)
furniture_scaled$score_knn <- rowMeans(furniture_knn$nn.dist)
largest_idx <- which.max(furniture_scaled$score_knn)
plot(furniture_scaled$Height, furniture_scaled$Width, cex=sqrt(furniture_scaled$score_knn), pch=20)
points(furniture_scaled$Height[largest_idx], furniture_scaled$Width[largest_idx], col="red", pch=20)
```



